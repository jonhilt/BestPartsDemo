@page "/contacts/all"
@using BestPartsDemo.Models
@using BestPartsDemo.Services
@inject IContactService ContactService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>All Contacts</PageTitle>

<ContactNav/>

<div class="mb-8 flex justify-between items-start">

    <p>The complete directory of everyone you've ever metâ€¦</p>

    <LinkButton href="/contacts/add">
        Add Contact
    </LinkButton>
</div>

@if (_isLoading)
{
    <LoadingSpinner Message="Loading all contacts..."/>
}
else
{
    <div class="mb-6 flex flex-col gap-4">
        <div class="max-w-md">
            <SearchInput Value="@SearchQuery"
                         ValueChanged="@HandleSearchChanged"
                         Placeholder="Search contacts by name, email, company, or role..."/>
        </div>

        <div class="flex items-center gap-3">
            <span class="text-gray-700 font-medium">Sort by:</span>
            <div class="flex gap-2">

                <SortButton OnClick="() => SetSortOrder(SortField.Name)"
                            Active="SortState?.Field == SortField.Name"
                            IsDescending="SortState?.IsDescending">
                    Name
                </SortButton>

                <SortButton OnClick="() => SetSortOrder(SortField.Company)"
                            Active="SortState?.Field == SortField.Company"
                            IsDescending="SortState?.IsDescending">
                    Company
                </SortButton>

                <SortButton OnClick="() => SetSortOrder(SortField.JobTitle)"
                            Active="SortState?.Field == SortField.JobTitle"
                            IsDescending="SortState?.IsDescending">
                    JobTitle
                </SortButton>

            </div>
        </div>

        @if (FilteredAndSortedContacts != null && FilteredAndSortedContacts.Any())
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                @foreach (var contact in FilteredAndSortedContacts)
                {
                    <ContactCard Contact="@contact"/>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(SearchQuery))
        {
            <div class="p-8 text-center text-gray-500">
                <p class="text-lg">No contacts found matching "@SearchQuery"</p>
                <p class="text-sm mt-2">Try adjusting your search terms</p>
            </div>
        }
    </div>

    @code {

        [PersistentState] public IEnumerable<Contact>? Contacts { get; set; }

        [SupplyParameterFromQuery(Name = "search")]
        public string? SearchQuery { get; set; }

        [PersistentState]
        public ContactSortState? SortState { get; set; }

        private bool _isLoading;

        protected override async Task OnInitializedAsync()
        {
            SortState ??= new ContactSortState(SortField.Name, false);
           
            if (Contacts == null || !Contacts.Any())
            {
                _isLoading = true;

                if (RendererInfo.IsInteractive)
                {
                    await Task.Delay(750); // Simulate loading delay for demo purposes
                }

                Contacts = await ContactService.GetAllContactsAsync();
                _isLoading = false;
            }
        }

        private IEnumerable<Contact>? FilteredContacts
        {
            get
            {
                return string.IsNullOrWhiteSpace(SearchQuery)
                    ? Contacts
                    : Contacts?.Where(c => c.Name.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase));
            }
        }

        private IEnumerable<Contact>? FilteredAndSortedContacts
        {
            get
            {
                var filtered = FilteredContacts;

                if (SortState == null)
                {
                    return filtered;
                }

                var sorted = SortState.Field switch
                {
                    SortField.Name => filtered?.OrderBy(c => c.Name),
                    SortField.Company => filtered?.OrderBy(c => c.Company),
                    SortField.JobTitle => filtered?.OrderBy(c => c.Role),
                    _ => filtered
                };

                return SortState.IsDescending ? sorted?.Reverse() : sorted;
            }
        }

        private void HandleSearchChanged(string? searchTerm)
        {
            Navigation.NavigateTo(
                Navigation.GetUriWithQueryParameter("search", searchTerm));
        }

        private void SetSortOrder(SortField field)
        {
            if (SortState?.Field == field)
            {
                SortState = SortState with { IsDescending = !SortState.IsDescending };
            }
            else
            {
                SortState = new ContactSortState(field, false);
            }
        }

    }

}
@page "/contacts/all"
@using BestPartsDemo.Models
@using BestPartsDemo.Services
@inject IContactService ContactService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>All Contacts</PageTitle>

<ContactNav/>

<div class="mb-8 flex justify-between items-start">

    <p>The complete directory of everyone you've ever metâ€¦</p>

    <LinkButton href="/contacts/add">
        Add Contact
    </LinkButton>
</div>

@if (_isLoading)
{
    <LoadingSpinner Message="Loading all contacts..."/>
}
else
{
    <div class="mb-6 flex flex-col gap-4">
        <div class="max-w-md">
            <SearchInput Value="@_searchTerm"
                         ValueChanged="@HandleSearchChanged"
                         Placeholder="Search contacts by name, email, company, or role..."/>
        </div>

        <div class="flex items-center gap-3">
            <span class="text-gray-700 font-medium">Sort by:</span>
            <div class="flex gap-2">

                <SortButton OnClick="() => SetSortOrder(SortField.Name)"
                            Active="_sortState?.Field == SortField.Name"
                            IsDescending="_sortState?.IsDescending">
                    Name
                </SortButton>

                <SortButton OnClick="() => SetSortOrder(SortField.Company)"
                            Active="_sortState?.Field == SortField.Company"
                            IsDescending="_sortState?.IsDescending">
                    Company
                </SortButton>

                <SortButton OnClick="() => SetSortOrder(SortField.JobTitle)"
                            Active="_sortState?.Field == SortField.JobTitle"
                            IsDescending="_sortState?.IsDescending">
                    JobTitle
                </SortButton>

            </div>
        </div>

        @if (FilteredAndSortedContacts != null && FilteredAndSortedContacts.Any())
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                @foreach (var contact in FilteredAndSortedContacts)
                {
                    <ContactCard Contact="@contact"/>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(_searchTerm))
        {
            <div class="p-8 text-center text-gray-500">
                <p class="text-lg">No contacts found matching "@_searchTerm"</p>
                <p class="text-sm mt-2">Try adjusting your search terms</p>
            </div>
        }
    </div>

    @code {

        [PersistentState] public IEnumerable<Contact>? Contacts { get; set; }

        [SupplyParameterFromQuery(Name = "search")]
        public string? SearchQuery { get; set; }

        private ContactSortState? _sortState;
        
        private bool _isLoading;
        private string _searchTerm = "";

        protected override async Task OnInitializedAsync()
        {
            _sortState ??= new ContactSortState(SortField.Name, false);
            _searchTerm = SearchQuery ?? "";

            if (Contacts == null || !Contacts.Any())
            {
                _isLoading = true;

                if (RendererInfo.IsInteractive)
                {
                    await Task.Delay(750); // Simulate loading delay for demo purposes
                }

                Contacts = await ContactService.GetAllContactsAsync();
                _isLoading = false;
            }
        }

        private IEnumerable<Contact>? FilteredContacts
        {
            get
            {
                return string.IsNullOrWhiteSpace(_searchTerm) 
                    ? Contacts
                    : Contacts?.Where(c => c.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
            }
        }

        private IEnumerable<Contact>? FilteredAndSortedContacts
        {
            get
            {
                var filtered = FilteredContacts;

                if (_sortState == null)
                {
                    return filtered;
                }

                var sorted = _sortState.Field switch
                {
                    SortField.Name => filtered?.OrderBy(c => c.Name),
                    SortField.Company => filtered?.OrderBy(c => c.Company),
                    SortField.JobTitle => filtered?.OrderBy(c => c.Role),
                    _ => filtered
                };

                return _sortState.IsDescending ? sorted?.Reverse() : sorted;
            }
        }

        private void HandleSearchChanged(string searchTerm)
        {
            _searchTerm = searchTerm;

            var url = string.IsNullOrWhiteSpace(searchTerm)
                ? "/contacts/all"
                : $"/contacts/all?search={Uri.EscapeDataString(searchTerm)}";

            Navigation.NavigateTo(url);
        }

        private void SetSortOrder(SortField field)
        {
            if (_sortState?.Field == field)
            {
                _sortState = _sortState with { IsDescending = !_sortState.IsDescending };
            }
            else
            {
                _sortState = new ContactSortState(field, false);
            }
        }

    }

}